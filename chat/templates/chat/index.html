{% extends "base.html" %}
{% block title %}Axiom{% endblock %}
{% block content %}
<div
  x-data="AxiomChat()"
  x-init="init()"
  @paste.window="onPaste($event)"
  class="h-full flex bg-neutral-950 text-neutral-100"
>
  <div class="relative flex shrink-0">
    <aside
      x-cloak
      :class="sidebarOpen ? 'w-72 px-5' : 'w-0 px-0'"
      class="bg-neutral-950/80 py-6 overflow-hidden transition-all duration-200"
    >
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-lg font-semibold">Sessions</h2>
    </div>
    <div class="flex items-center justify-between mb-4">
      <a
        href="{% url 'chat_home' %}?new=1"
        class="text-xs uppercase tracking-widest text-neutral-400 hover:text-white"
      >
        New
      </a>
    </div>
    <div class="space-y-3">
      {% for session in sessions %}
        <a
          href="{% url 'chat_session' session.id %}"
          class="block rounded-xl border border-neutral-800 px-3 py-2 text-sm hover:border-neutral-600 {% if active_session and session.id == active_session.id %}bg-neutral-900{% endif %}"
        >
          <div class="font-medium truncate">{{ session.title|default:"Untitled" }}</div>
          <div class="text-xs text-neutral-500 mt-1">{{ session.updated_at|date:"M d, H:i" }}</div>
        </a>
      {% empty %}
        <p class="text-sm text-neutral-500">No sessions yet.</p>
      {% endfor %}
    </div>
  </aside>

    </aside>

    <div class="w-px bg-neutral-800/80 transition-all duration-200"></div>

    <button
      class="absolute -right-3 top-6 z-10 h-7 w-7 rounded-full border border-neutral-700 bg-neutral-900 text-neutral-200 hover:text-white hover:border-neutral-500 transition"
      @click="sidebarOpen = !sidebarOpen"
      type="button"
      aria-label="Toggle sidebar"
    >
      <i :class="sidebarOpen ? 'fa-solid fa-angles-left' : 'fa-solid fa-angles-right'"></i>
    </button>
  </div>

  <main class="flex-1 flex flex-col h-full">
    <header class="border-b border-neutral-800">
      <div class="mx-auto w-full max-w-3xl px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
        <a href="{% url 'chat_home' %}?new=1" class="block">
          <h1 class="text-xl font-semibold">Axiom</h1>
          <p class="text-xs text-neutral-500">Research agent</p>
        </a>
        </div>
        <div class="flex items-center gap-4 text-lg text-neutral-300">
        <a
          href="{% url 'chat_home' %}?new=1"
          class="hover:text-white"
          aria-label="New chat"
        >
          <i class="fa-regular fa-pen-to-square"></i>
        </a>
        <form method="post" action="{% url 'logout' %}">
          {% csrf_token %}
          <button class="hover:text-white" aria-label="Log out">
            <i class="fa-solid fa-right-from-bracket"></i>
          </button>
        </form>
        </div>
      </div>
    </header>

    <section id="chat-scroll" class="flex-1 overflow-y-auto px-4 py-6" x-ref="scrollArea">
      <div id="chat-list" class="mx-auto w-full max-w-3xl" data-username="{{ request.user.username|escapejs }}" x-ref="chatList">
      <div id="chat-messages" class="space-y-6">
        <template x-if="messages.length === 0">
          <div class="text-neutral-500 max-w-xl">
            <p class="text-lg font-semibold text-neutral-300">Start a research thread</p>
            <p class="mt-2">Ask a question and I will search the web and summarize findings.</p>
          </div>
        </template>
        <template x-for="message in messages" :key="message.id">
          <div class="max-w-3xl" :class="message.role === 'user' ? 'ml-auto text-right' : ''">
            <div class="text-xs uppercase tracking-widest text-neutral-500 mb-2" x-text="message.role === 'user' ? username : 'Axiom'"></div>
            <div
              class="rounded-2xl px-4 py-3 border border-neutral-800"
              :class="message.role === 'user' ? 'bg-neutral-900/80' : 'bg-neutral-950'"
            >
              <template x-if="message.role === 'assistant'">
                <template x-if="message.content">
                  <div class="assistant-markdown text-sm leading-relaxed space-y-3" x-html="renderAssistant(message.content)"></div>
                </template>
              </template>
              <template x-if="message.role === 'assistant' && message.status === 'pending'">
                <div class="text-sm leading-relaxed text-neutral-400">
                  Working on it...
                </div>
              </template>
              <template x-if="message.role !== 'assistant'">
                <div class="text-sm leading-relaxed whitespace-pre-wrap" x-text="message.content"></div>
              </template>
              <template x-if="message.attachments && message.attachments.length">
                <div class="mt-3 grid grid-cols-2 gap-3">
                  <template x-for="attachment in message.attachments" :key="attachment.url">
                    <img :src="attachment.url" alt="attachment" class="rounded-xl border border-neutral-800" />
                  </template>
                </div>
              </template>
            </div>
          </div>
        </template>
      </div>
      </div>
    </section>

    <footer class="px-4 pb-6">
      <div class="mx-auto w-full max-w-3xl bg-neutral-900/70 border border-neutral-800 rounded-2xl p-3">
      <form id="chat-form" class="flex items-end gap-3" @submit.prevent="sendMessage()">
          {% csrf_token %}
          <button
            type="button"
            id="image-trigger"
            class="shrink-0 w-9 h-9 rounded-full border border-neutral-700 hover:border-neutral-500 flex items-center justify-center text-neutral-300"
            @click="openImagePicker()"
          >
            +
          </button>
          <div id="image-preview" class="hidden items-center gap-2" x-ref="imagePreview">
            <img id="image-preview-img" class="h-8 w-8 rounded-md border border-neutral-700 object-cover" alt="attachment preview" x-ref="imagePreviewImg" />
            <button id="image-clear" type="button" class="text-xs text-neutral-400 hover:text-white" @click="clearImage()">Remove</button>
          </div>
          <input id="image-input" type="file" name="image" accept="image/*" class="hidden" x-ref="imageInput" @change="onImageChange($event)" />
          <textarea
            id="chat-input"
            name="message"
            rows="1"
            placeholder="Ask Axiom..."
            class="flex-1 bg-transparent resize-none outline-none text-sm leading-6 text-neutral-100 placeholder:text-neutral-500"
            x-ref="input"
            @input="autoResize()"
            @keydown="handleKeydown($event)"
          ></textarea>
          <button
            type="submit"
            class="shrink-0 px-4 py-2 rounded-xl bg-white text-neutral-900 text-sm font-semibold hover:bg-neutral-200"
          >
            Send
          </button>
        </form>
        <p class="mt-2 text-xs text-neutral-500">Shift + Enter for a new line.</p>
      </div>
    </footer>
  </main>
</div>

<script>
  function escapeHtml(value) {
    const map = { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" };
    return String(value).replace(/[&<>"']/g, (char) => map[char]);
  }

  function stripInlineSources(text) {
    return text
      .replace(/\s*\[\d+\]\([^)]+\)/g, "")
      .replace(/\s*\[\d+\]/g, "")
      .replace(/\s*\[\u00b9\]/g, "")
      .replace(/\s*\[\u00b2\]/g, "")
      .replace(/\s*\[\u00b3\]/g, "")
      .replace(/\s*\[\u2074\]/g, "")
      .replace(/\n+Sources:\s*[\s\S]*$/i, "");
  }

  function decodeEscapes(value) {
    try {
      return JSON.parse(`"${value}"`);
    } catch (error) {
      return value;
    }
  }

  function renderMarkdown(text) {
    const imageBlocks = [];
    const codeBlocks = [];
    let working = text.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (match, alt, url) => {
      const idx = imageBlocks.length;
      imageBlocks.push({ alt, url });
      return `@@IMG${idx}@@`;
    });
    working = working.replace(/```([\s\S]*?)```/g, (match, code) => {
      const idx = codeBlocks.length;
      codeBlocks.push(code);
      return `@@CODE${idx}@@`;
    });
    working = working.replace(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g, "$1 ($2)");

    let safe = escapeHtml(working);
    safe = safe.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
    safe = safe.replace(/\*(.+?)\*/g, "<em>$1</em>");
    safe = safe.replace(/`([^`]+)`/g, "<code>$1</code>");

    const lines = safe.split(/\n/);
    let html = "";
    let inList = false;
    let tableRows = [];

    const flushList = () => {
      if (inList) {
        html += "</ul>";
        inList = false;
      }
    };

    const flushTable = () => {
      if (!tableRows.length) return;
      const [header, ...rows] = tableRows;
      html += "<table><thead><tr>";
      header.forEach((cell) => {
        html += `<th>${cell}</th>`;
      });
      html += "</tr></thead><tbody>";
      rows.forEach((row) => {
        html += "<tr>";
        row.forEach((cell) => {
          html += `<td>${cell}</td>`;
        });
        html += "</tr>";
      });
      html += "</tbody></table>";
      tableRows = [];
    };

    const parseTableRow = (line) =>
      line
        .split("|")
        .map((cell) => cell.trim())
        .filter((cell) => cell.length);

    for (let i = 0; i < lines.length; i++) {
      const raw = lines[i];
      const trimmed = raw.trim();
      if (!trimmed) {
        flushList();
        flushTable();
        html += "<br>";
        continue;
      }

      const headingMatch = trimmed.match(/^(#{2,3})\s+(.*)$/);
      if (headingMatch) {
        flushList();
        flushTable();
        html += `<h3>${headingMatch[2]}</h3>`;
        continue;
      }

      const listMatch = trimmed.match(/^- (.+)$/);
      if (listMatch) {
        flushTable();
        if (!inList) {
          html += "<ul>";
          inList = true;
        }
        html += `<li>${listMatch[1]}</li>`;
        continue;
      }

      const isTableLine = trimmed.includes("|");
      const next = lines[i + 1]?.trim() || "";
      const isSeparator = /^\|?[\s:-]+\|?([\s:-]+\|?)+$/.test(next);
      if (isTableLine && isSeparator) {
        flushList();
        const header = parseTableRow(trimmed);
        i += 1;
        tableRows = [header];
        continue;
      }
      if (tableRows.length && isTableLine) {
        tableRows.push(parseTableRow(trimmed));
        continue;
      }

      flushList();
      flushTable();
      html += `<p>${trimmed}</p>`;
    }

    flushList();
    flushTable();

    codeBlocks.forEach((code, idx) => {
      const escaped = escapeHtml(code.trim());
      html = html.replace(`@@CODE${idx}@@`, `<pre><code>${escaped}</code></pre>`);
    });
    imageBlocks.forEach((img, idx) => {
      const safeAlt = escapeHtml(img.alt || "image");
      const safeUrl = escapeHtml(img.url);
      html = html.replace(
        `@@IMG${idx}@@`,
        `<img src="${safeUrl}" alt="${safeAlt}" class="rounded-xl border border-neutral-800 max-w-full" />`
      );
    });

    return html || "<p></p>";
  }

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
  }

  const initialMessages = [
  {% for message in messages %}
    {
      id: "{{ message.id }}",
      role: "{{ message.role }}",
      content: "{{ message.content|escapejs }}",
      status: {% if message.role == "assistant" and not message.content %}"pending"{% else %}"complete"{% endif %},
      attachments: [
        {% for attachment in message.attachments.all %}
          { url: "{{ attachment.image.url }}" },
        {% endfor %}
      ],
    },
  {% endfor %}
  ];

  function AxiomChat() {
    return {
      messages: initialMessages,
      username: "{{ request.user.username|escapejs }}",
      sidebarOpen: localStorage.getItem("axiom_sidebar_open")
        ? localStorage.getItem("axiom_sidebar_open") === "true"
        : true,
      activeSessionId: "{{ active_session.id|default:'' }}",
      pastedImage: null,
      refreshInFlight: false,
      pendingRefreshTimer: null,
      pendingRefreshAttempts: 0,
      init() {
        this.$watch("sidebarOpen", (value) => localStorage.setItem("axiom_sidebar_open", value));
        this.setupVisibilityRefresh();
        this.autoResize();
        this.$refs.scrollArea.scrollTop = this.$refs.scrollArea.scrollHeight;
        if (this.activeSessionId) {
          this.refreshSessionMessages().then(() => {
            if (this.hasPendingAssistant()) {
              this.schedulePendingRefresh();
            }
          });
        }
      },
      renderAssistant(text) {
        return renderMarkdown(stripInlineSources(text || ""));
      },
      openImagePicker() {
        this.$refs.imageInput.click();
      },
      clearImage() {
        this.pastedImage = null;
        this.$refs.imageInput.value = "";
        this.$refs.imagePreviewImg.src = "";
        this.$refs.imagePreview.classList.add("hidden");
      },
      showPreview(file) {
        if (!file) return;
        this.$refs.imagePreviewImg.src = URL.createObjectURL(file);
        this.$refs.imagePreview.classList.remove("hidden");
      },
      onPaste(event) {
        const files = event.clipboardData?.files || [];
        const items = event.clipboardData?.items || [];
        let file = files[0] || null;
        if (!file) {
          for (const item of items) {
            if (item.type && item.type.startsWith("image/")) {
              file = item.getAsFile();
              break;
            }
          }
        }
        if (file) {
          this.pastedImage = file;
          this.$refs.imageInput.value = "";
          this.showPreview(file);
          event.preventDefault();
        }
      },
      onImageChange(event) {
        this.pastedImage = event.target.files[0] || null;
        if (this.pastedImage) {
          this.showPreview(this.pastedImage);
        } else {
          this.$refs.imagePreview.classList.add("hidden");
        }
      },
      handleKeydown(event) {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          this.sendMessage();
        }
      },
      autoResize() {
        const input = this.$refs.input;
        input.style.height = "auto";
        input.style.height = Math.min(input.scrollHeight, 180) + "px";
      },
      normalizeMessage(message) {
        const status =
          message.status ||
          (message.role === "assistant" && !message.content ? "pending" : "complete");
        return {
          id: message.id,
          role: message.role,
          content: message.content || "",
          status,
          attachments: message.attachments || [],
        };
      },
      mergeMessages(serverMessages) {
        const normalizedServer = serverMessages.map((msg) => this.normalizeMessage(msg));
        const serverHasPending = normalizedServer.some(
          (msg) => msg.role === "assistant" && msg.status === "pending"
        );
        const serverIds = new Set(normalizedServer.map((msg) => msg.id));
        let localPending = this.messages.filter((msg) => msg.status === "pending");
        if (serverHasPending) {
          localPending = localPending.filter((msg) => !String(msg.id).startsWith("local-assistant-"));
        }
        const merged = [...normalizedServer];
        localPending.forEach((msg) => {
          if (!serverIds.has(msg.id)) {
            merged.push(msg);
          }
        });
        this.messages = merged;
      },
      async sendMessage() {
        const input = this.$refs.input;
        const message = input.value.trim();
        if (!message && !this.pastedImage) return;
        const displayMessage = message || "Image attached";

        const sessionId = "{{ active_session.id|default:'' }}";
        const forceNew = "{{ force_new|default:'' }}" === "True";
        const formData = new FormData();
        formData.append("message", message);
        if (sessionId && !forceNew) {
          formData.append("session_id", sessionId);
        }
        if (this.pastedImage) {
          formData.append("image", this.pastedImage);
        }

        const localUserId = `local-user-${Date.now()}`;
        const localAssistantId = `local-assistant-${Date.now()}`;

        input.value = "";
        this.$refs.imageInput.value = "";
        this.pastedImage = null;
        this.$refs.imagePreviewImg.src = "";
        this.$refs.imagePreview.classList.add("hidden");
        this.autoResize();

        this.messages.push({
          id: localUserId,
          role: "user",
          content: displayMessage,
          status: "complete",
          attachments: [],
        });
        this.messages.push({
          id: localAssistantId,
          role: "assistant",
          content: "",
          status: "pending",
          attachments: [],
        });
        this.$nextTick(() => {
          this.$refs.scrollArea.scrollTop = this.$refs.scrollArea.scrollHeight;
        });

        const response = await fetch("{% url 'chat_send' %}", {
          method: "POST",
          headers: { "X-CSRFToken": getCookie("csrftoken") },
          body: formData,
        });

        const data = await response.json();
        if (!response.ok) {
          const errorText = data.error || "Something went wrong.";
          const pending = this.messages.find((item) => item.id === localAssistantId);
          if (pending) {
            pending.content = errorText;
            pending.status = "error";
          } else {
            this.messages.push({
              id: `error-${Date.now()}`,
              role: "assistant",
              content: errorText,
              status: "error",
              attachments: [],
            });
          }
          this.$nextTick(() => {
            this.$refs.scrollArea.scrollTop = this.$refs.scrollArea.scrollHeight;
          });
          return;
        }

        const pending = this.messages.find((item) => item.id === localAssistantId);
        if (pending) {
          pending.content = data.assistant_message || "";
          pending.status = "complete";
        } else {
          this.messages.push({
            id: `assistant-${Date.now()}`,
            role: "assistant",
            content: data.assistant_message || "",
            status: "complete",
            attachments: [],
          });
        }

        if ((!sessionId || forceNew) && data.session_id) {
          window.location.href = `/chat/${data.session_id}/`;
        }

        this.$nextTick(() => {
          this.$refs.scrollArea.scrollTop = this.$refs.scrollArea.scrollHeight;
        });
      },
      hasPendingAssistant() {
        return this.messages.some((item) => item.role === "assistant" && item.status === "pending");
      },
      async refreshSessionMessages() {
        if (!this.activeSessionId || this.refreshInFlight) return false;
        this.refreshInFlight = true;
        try {
          const response = await fetch(`/api/chat/session/${this.activeSessionId}/messages/`, {
            headers: { "X-Requested-With": "XMLHttpRequest" },
          });
          if (!response.ok) return false;
          const data = await response.json();
          if (data.messages) {
            this.mergeMessages(data.messages);
            this.$nextTick(() => {
              this.$refs.scrollArea.scrollTop = this.$refs.scrollArea.scrollHeight;
            });
            return true;
          }
          return false;
        } finally {
          this.refreshInFlight = false;
        }
      },
      schedulePendingRefresh() {
        if (!this.activeSessionId) return;
        if (this.pendingRefreshTimer) return;
        this.pendingRefreshAttempts = 0;
        this.pendingRefreshTimer = setInterval(async () => {
          this.pendingRefreshAttempts += 1;
          await this.refreshSessionMessages();
          if (!this.hasPendingAssistant() || this.pendingRefreshAttempts >= 6) {
            clearInterval(this.pendingRefreshTimer);
            this.pendingRefreshTimer = null;
          }
        }, 2000);
      },
      setupVisibilityRefresh() {
        window.addEventListener("pageshow", (event) => {
          if (event.persisted) {
            this.refreshSessionMessages().then(() => {
              if (this.hasPendingAssistant()) {
                this.schedulePendingRefresh();
              }
            });
          }
        });
        document.addEventListener("visibilitychange", () => {
          if (document.visibilityState === "visible" && this.hasPendingAssistant()) {
            this.schedulePendingRefresh();
          }
        });
      },
    };
  }
</script>
{% endblock %}
